<!DOCTYPE html>
<html>

<head>
	<meta charset='utf-8'>
	<meta http-equiv='X-UA-Compatible' content='IE=edge'>
	<title>4han</title>
	<meta name='viewport' content='width=device-width, initial-scale=1'>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"
		integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	<link rel="icon" href="/favicon.ico" />

	<style>
		/* In Page appearance order */
		/* Theme Variables */
		:root {
			--background-color: aliceblue;
			--color: black;
			--inlay-background-color: #d8daef;
			--border-color: #c1c7d9;
			--alert-color: red;
			--link-color: blue;

			--fourhan-logo-title: #a10000;

			--control-color: inherit;

			--selected-post-background-color: #d6bad0;

			--form-input-background-color: white;

			--post-name-color: green;
			--post-date-color: inherit;
			--post-title-color: #a10000;
			--reference-color: #a10000;
			--greentext-color: green;

			--icon-color: white;
			--icon-background-color: #9198ce;
			--icon-border-color: #323151;

			--spoiler-color: black;
		}

		body#dark-theme {
			--background-color: #1d2021;
			--color: #dfdfdf;
			--inlay-background-color: #282828;
			--border-color: #4b4b4b;
			--alert-color: #ce0000;
			--link-color: #458588;

			--fourhan-logo-title: #a10000;

			--control-color: #458588;

			--selected-post-background-color: #505050;

			--form-input-background-color: #1d2021;

			--post-name-color: #458588;
			--post-date-color: gray;
			--post-title-color: #ce0000;
			--reference-color: #458588;
			--greentext-color: #789922;

			--icon-color: white;
			--icon-background-color: #9198ce;
			--icon-border-color: #323151;

			--spoiler-color: #dfdfdf;
		}

		/* General Styles */

		body {
			background-color: var(--background-color);
			color: var(--color);
			font-family: 'Helvetica', 'Arial', sans-serif;
			margin: 0;
		}

		.template,
		.hidden {
			display: none !important;
		}

		a,
		span.link {
			color: var(--link-color);
			outline: 0;
		}

		/* Page Header (banner for name collision avoidance) */

		.banner {
			text-align: center;
		}

		.banner .title>a {
			font-family: 'Impact', sans-serif;
			text-decoration: none;
			color: var(--fourhan-logo-title);
			font-size: 64px;
			font-weight: bold;
		}

		.repo h3 {
			display: inline;
		}

		/* Post Creation Form */

		.form {
			margin-top: 8px;
			display: inline-block;
			background-color: var(--inlay-background-color);
			border: 1px solid var(--border-color);
		}

		.form form {
			padding: 4px;
			display: inline-block;
			width: 480px;
			box-sizing: border-box;
			font-size: 14px;
		}

		.form.floating {
			position: absolute;
		}

		.form.floating .drag {
			border-bottom: 1px solid var(--border-color);
			text-align: right;
			padding-right: 4px;
		}

		.form.floating .x {
			cursor: pointer;
			user-select: none;
		}

		.form form .row {
			margin-top: 4px;
			display: flex;
			align-items: center;
		}

		.form-container {
			text-align: center;
			margin-bottom: 12px;
		}

		.form textarea {
			resize: vertical;
			display: block;
			width: 100%;
			margin-top: 4px;
			box-sizing: border-box;
			min-height: 100px;
		}

		form textarea,
		form input[type=text] {
			background-color: var(--form-input-background-color);
			border-color: var(--border-color);
			color: var(--color);
		}

		.row label {
			min-width: 50px;
			margin-right: 4px;
		}

		.form .row input[type=text] {
			flex: 1;
		}


		.form .row input[type=file] {
			min-width: 80px;
			flex-basis: 80px;
			flex: 1;
		}

		.form .row .error {
			margin: 0px 4px;
			font-weight: bold;
			color: var(--alert-color);
		}

		/* Control Bar */


		.control {
			color: var(--control-color);
			display: flex;
			user-select: none;
			gap: 4px;
			padding: 0px 12px;
		}

		.control .spread {
			flex: 1;
		}

		.control>span {
			text-decoration: none;
		}

		.control .button {
			cursor: pointer;
			color: var(--link-color);
		}

		.control>span.button:hover {
			text-decoration: underline;
		}


		.control .notification {
			flex: 1;
			text-align: right;
			font-weight: bold;
			color: var(--alert-color);
		}

		.control #refresh-error {
			color: var(--alert-color);
			font-weight: bold;
		}

		/* Posts and Threads */

		.thread {
			padding: 8px;
			display: block;
			margin-top: 8px;
		}

		.thread::after {
			content: "";
			display: block;
			height: 0;
			clear: both;
		}

		.header .name {
			font-weight: bold;
			color: var(--post-name-color);
		}

		.header .title {
			font-weight: bold;
			color: var(--post-title-color);
		}

		.header .date {
			position: relative;
			display: inline-block;
			color: var(--post-date-color);
		}

		.tooltiptext {
			position: absolute;
			display: none;
			bottom: 100%;
			width: 100%;
			background-color: rgb(70, 70, 70);
			color: #fff;
			text-align: center;
			padding: 5px;
			font-size: 12px;
			z-index: 9999;
		}

		.header .date:hover .tooltiptext {
			display: block;
		}

		.header .numbers {
			color: var(--link-color);
			cursor: pointer;
		}

		.header .quotes {
			word-wrap: break-word;
			position: relative;
		}

		.bannerImage {
			max-width: 400px;
			cursor: pointer;
		}

		.divider {
			border-bottom: 2px solid var(--border-color);
			margin: 4px 0px;
		}

		.divider.limit,
		.divider.new-posts-line {
			border-color: var(--alert-color);
		}

		.divider.new-posts-line {
			padding-top: 4px;
			margin-bottom: -2px;
		}

		.image {
			float: left;
			margin-right: 12px;
			margin-left: 12px;
			cursor: pointer;
			max-width: 95%;
		}

		.thumb {
			max-width: 256px;
			max-height: 256px;
		}

		span.spoiler {
			background: var(--spoiler-color);
			color: var(--spoiler-color);
		}

		span.spoiler:hover {
			background: inherit;
		}

        span.spoiler a {
            color: inherit;
        }

        span.spoiler:hover a {
            color: revert;
        }

        span.spoiler:hover a.reference {
            color: var(--reference-color);
        }

		.image.spoiler {
			width: 128px;
			height: 128px;
			min-width: 128px !important;
			min-height: 128px !important;
			border-radius: 8px;
			content: url("boards/spoiler.jpeg");
		}

		h1 {
			margin-left: 40px;
		}

		.post .arrows {
			color: var(--border-color);
			float: left;
			margin-top: 12px;
			margin-right: 4px;
			user-select: none;
		}

		.content:has(a:target) {
			background-color: var(--selected-post-background-color);
		}

		.post .content {
			display: inline-block;
			background-color: var(--inlay-background-color);
			margin-top: 12px;
			border-bottom: 1px solid var(--border-color);
			border-right: 1px solid var(--border-color);
			color: var(--color);
			padding: 4px 8px;
			max-width: 80%;
			min-width: 600px;
			min-height: 70px;
			position: relative;
		}

		.post .body,
		.thread .body {
			padding-left: 24px;
			padding-bottom: 8px;
			padding-top: 15px;
			white-space: pre-wrap;
		}

		.body .greentext {
			color: var(--greentext-color);
		}

		.reference {
			color: var(--reference-color);
			cursor: pointer;
			text-decoration: underline;
			position: relative;
		}

		.reference.deleted {
			text-decoration: line-through;
			cursor: inherit;
			color: var(--alert-color)
		}

		.quotes .reference {
			display: inline-block;
			margin-right: 4px;
		}

		.post-preview {
			z-index: 1;
			margin-top: 20px;
			position: absolute;
			display: inline-block;
		}

		.post-preview.right {
			right: 0;
		}

		.post-preview,
		.post-preview .header,
		.post-preview .meta {
			white-space: normal;
		}

		.menu {
			position: relative;
			cursor: pointer;
			font-size: 10px;
			user-select: none;
		}

		.menu .options {
			position: absolute;
			top: 100%;
			left: 0;
			background-color: var(--inlay-background-color);
			font-size: 16px;
		}

		.menu .options>* {
			border-bottom: 1px solid var(--border-color);
			padding: 2px 4px;
		}

		.banned {
			color: var(--alert-color);
			font-weight: bold;
		}

		.expander .link,
		.collapser .link {
			color: var(--link-color);
			cursor: pointer;
		}

		/* Icons */

		.icon.minus,
		.icon.plus {
			display: inline-block;
			color: var(--icon-color);
			font-weight: bold;
			font-size: 16px;
			line-height: 16px;
			height: 16px;
			width: 16px;
			text-align: center;
			background-color: var(--icon-background-color);
			border: 2px solid var(--icon-border-color);
			border-radius: 3px;
			cursor: pointer;
		}

		.icon.plus::before {
			content: '＋';
		}

		.icon.minus::before {
			content: '－';
		}

		/* Page Selector */
		.pages {
			padding: 0px 12px 8px;
			text-align: right;
		}

		.pages .page-link {
			margin-left: 4px;
		}

		.pages .page-link a {
			padding: 2px;
		}


		.pages .page-link.current a {
			text-decoration: none;
		}

		.pages .page-link.current {
			font-weight: bold;
		}

		/* Catalog Page */

		#catalog {
			padding: 16px;
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
			gap: 16px;
		}

		#catalog .catalog-item {
			max-width: 190px;
			text-align: center;
		}

		#catalog .catalog-item .replies {
			font-size: 12px;
		}

		#catalog .catalog-item .image {
			width: 190px;
			height: 190px;
			object-fit: scale-down;
			justify-content: center;
			cursor: pointer;
		}

		#catalog .catalog-item .body {
			max-height: 150px;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		#catalog .catalog-item .body .title {
			font-weight: bold;
		}

		.theme-selector-box {
			padding-left: 10px;
		}
	</style>
</head>

<body>
	<script>
		const banners = [
			"0.png",
			"11.png",
			"13.jpg",
			"15.jpg",
			"17.jpg",
			"19.jpg",
			"20.jpg",
			"22.jpg",
			"24.png",
			"26.png",
			"28.png",
			"2.jpg",
			"31.png",
			"3.png",
			"4.png",
			"6.png",
			"8.png",
			"10.jpg",
			"12.jpg",
			"14.jpg",
			"16.png",
			"18.jpg",
			"1.png",
			"21.jpg",
			"23.jpg",
			"25.png",
			"27.png",
			"29.png",
			"30.png",
			"32.gif",
			"5.png",
			"7.png",
			"9.png",
			"4han/0.gif",
			"4han/1.png",
			"4han/2.gif",
			"4han/3.gif",
			"4han/4.png",
			"4han/5.png",
			"4han/6.gif",
			"4han/7.png",
			"4han/8.gif",
			"4han/9.png",
			"4han/10.png",
			"4han/11.png",
			"4han/12.gif",
			"4han/13.png",
			"4han/14.png",
			"4han/15.png",
			"4han/16.png",
			"4han/17.png",
			"4han/18.gif",
			"4han/19.png",
			"4han/20.png",
			"4han/21.png",
			"4han/22.gif",
		];

		const dev = window.location.hostname === 'localhost ';
		const baseUrl = dev ? "http://localhost:9515/" : "https://riichi.moe/api/";
		const imageBaseUrl = dev ? 'http://localhost:8080' : `${baseUrl}bulletin/images`
		const maxFileSize = 1024 * 1024;

		const dayOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thur", "Fri", "Sat"];

        const newPostObserver = new IntersectionObserver((entries, observer) => {
            for (const entry of entries) {
                if (entry.isIntersecting) {
                    globalData.unreadPosts--;
                    observer.unobserve(entry.target);
                }
            }

            if (globalData.unreadPosts) {
                document.title = `(${globalData.unreadPosts}) ${globalData.originalTitle}`;
            } else {
                $(".thread .new-posts-line").remove();
                document.title = globalData.originalTitle;
                globalData.originalTitle = undefined;

                if (globalData.originalFavicon) {
                    $('link[rel="icon"]').replaceWith(globalData.originalFavicon);
                    delete globalData.originalFavicon;
                }
            }
        }, {threshold: 1.0});

		function imageUrl(id, imageData, thumb) {
			if (!imageData.extension) {
				return `${imageBaseUrl}/${thumb ? 'thumb' : 'full'}/${id}`
			}

			if (!thumb) {
				return `${imageBaseUrl}/full/${id}.${imageData.extension}`
			}

			const thumbIsScaled = imageData.dimensions[0] !== imageData.thumbDimensions[0]
				|| imageData.dimensions[1] !== imageData.thumbDimensions[1];
			return `${imageBaseUrl}/thumb/${id}.${thumbIsScaled ? 'webp' : imageData.extension}`
		}

		function uuidv4() {
			return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
				(+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
			);
		}

		function getDeleteId() {
			const deleteId = localStorage.getItem('deleteId')

			if (deleteId) {
				return deleteId;
			}

			const newDeleteId = uuidv4()
			localStorage.setItem('deleteId', newDeleteId)
			return newDeleteId
		}

		function getThreadId() {
			const match = window.location.pathname.match(/(\d+)\/?/)
			if (!match) {
				return null
			}
			return match[0]
		}

		function getPageNumber() {
			const urlParams = new URLSearchParams(window.location.search);
			return urlParams.get('page') ?? 1;
		}

		const globalData = {
			threadId: getThreadId(),
			pageNumber: getPageNumber(),
			selectedText: '',
			authoredPostIds: new Set(),
			postIds: new Set(),
		};
		const deleteId = getDeleteId()
		const authToken = localStorage.getItem('authToken')
		const authHeaders = authToken ? {
			"Authorization": `Bearer ${authToken}`
		} : {}

		$('body').attr('id', localStorage.getItem('theme') ?? '');

		function toReadableFileSize(fileSize) {
			if (fileSize > 1000000) {
				return Math.round(fileSize / 100000) / 10 + "MB"
			}
			if (fileSize > 1000) {
				return Math.round(fileSize / 1000) + "KB"
			}
			return fileSize + "B"
		}

		// NB: For resetting the scroll position on page refresh
		try {
			const scrollPos = JSON.parse(sessionStorage.getItem('scrollpos'))
			localStorage.removeItem('scrollpos')
			const pageAccessedByReload = (
				(window.performance.navigation && window.performance.navigation.type === 1) ||
				window.performance
					.getEntriesByType('navigation')
					.map((nav) => nav.type)
					.includes('reload')
			);
			if (pageAccessedByReload) {
				globalData.deferredScroll = { position: scrollPos }
			}
		} catch { }

		function saveScrollPosOnRefresh() {
			window.onbeforeunload = function (e) {
				sessionStorage.setItem('scrollpos', JSON.stringify(window.scrollY))
			}
		}

		// NB: This is invoked when all the images have finished loading to
		// either restore the scroll position after a refresh, or to jump
		// down to the post that was linked.
		function restoreScrollPos() {
			if (globalData.deferredScroll?.position) {
				window.scrollTo(0, globalData.deferredScroll.position)
			}
			delete globalData.deferredScroll
		}

		function reloadAuthoredPostIds() {
			try {
				JSON.parse(localStorage.getItem('authoredPostIds')).forEach(id => globalData.authoredPostIds.add(id))
			} catch { }
		}
		reloadAuthoredPostIds()

		function addAuthoredPostId(id) {
			id = parseInt(id.trim(), 10)
			if (isNaN(id)) {
				console.warn("invalid authoredPostId", id)
				return
			}

			let oldIds;
			try {
				oldIds = JSON.parse(localStorage.getItem('authoredPostIds')) ?? []
			} catch {
				oldIds = []
			}
			oldIds.push(id)
			if (oldIds.length > 500) {
				oldIds = oldIds.slice(oldIds.length - 500)
			}
			localStorage.setItem('authoredPostIds', JSON.stringify(oldIds))
			globalData.authoredPostIds.add(id)
		}

		function renderReference(id) {
			id = parseInt(id, 10)
			let extra = globalData.authoredPostIds.has(parseInt(id, 10)) ? ' (You)' : ''
			if (!globalData.postIds.has(id)) {
				extra = `${extra}&rarr;`
			}
			return `<a class="reference" href=${getReferenceHref(id)}>&gt;&gt;${id}${extra}</a>`
		}

		function renderOP(entry) {
			const newThread = $('.thread.template').clone();
			newThread.removeClass('template');
			if (!(Object.keys(entry).includes('imageData'))) {
				newThread.find('.meta').addClass('hidden');
			}
			renderSharedData(newThread, entry);

			const ommittedReplies = entry.replies - 5;
			if (!entry.replies || ommittedReplies <= 0 || globalData.threadId) {
				return newThread;
			}

			newThread.find('.expander').removeClass('hidden');
			newThread.find('.expander .replies-count').text(`${ommittedReplies} replies omitted.`);
			newThread.find('.expander .icon.plus, .expander .link').on('click', () => {
				fetch(baseUrl + "bulletin/" + entry.postNumber, {
					headers: authHeaders
				})
					.then(body => body.json())
					.then(data => {
						newThread.find('.post').remove();
						newThread.find('.expander').addClass('hidden')
						newThread.find('.collapser').removeClass('hidden')
						data.posts.forEach(post => {
							const newPost = renderPost(post)
							newPost.appendTo(newThread);
						})
					});
			});

			newThread.find('.collapser .icon.minus, .collapser .link').on('click', () => {
				newThread.find('.post').slice(0, -5).remove();
				newThread.find('.expander').removeClass('hidden')
				newThread.find('.collapser').addClass('hidden')
			});

			return newThread;
		}

		function loadIndex() {
			fetch(baseUrl + "bulletin?pageNumber=" + globalData.pageNumber, {
				headers: authHeaders
			})
				.then(body => body.json())
				.then(data => {
					const divider = $('<div/>').addClass('divider')

					const pageLinks = [...Array(data.pageCount)]
						.map((_, i) =>
							$('.page-link.template')
								.clone()
								.toggleClass('current', (i + 1).toString() === globalData.pageNumber)
								.removeClass('template')
								.find('a')
								.text(i + 1)
								.attr('href', '/?page=' + (i + 1))
								.end()
						)
					$('.pages').removeClass('hidden').append(pageLinks)
					const threads = data.page.flatMap((entry) => {
						const op = renderOP(entry.thread)
						const posts = entry.posts.map(post => renderPost(post))
						op.append(posts)
						return [
							$('<div/>').addClass('divider'),
							op,
						]
					}).slice(1)
					$('#main').append(threads)
				})
		}

		function showNotFound() {

		}

		function renderPost(post) {
			const newPost = $('.post.template').clone()
			newPost.removeClass('template')
			renderSharedData(newPost, post)
			return newPost;
		}

		function renderPreview(targetPost, reference) {
			const preview = $('<div>', { class: 'post post-preview' })
				.append(targetPost)
				.find('a').removeAttr('id').end()
				.insertBefore(reference)

			const windowWidth = $(window).width()
			const previewWidth = preview.width()
			const previewPosition = preview.offset().left;
			if (previewPosition + previewWidth > windowWidth && previewPosition - previewWidth > 0) {
				preview.addClass('right')
			}

			return preview
		}

		function getReferenceHref(referenceId, parentThreadNumber) {
			if (parentThreadNumber) {
				return '/' + parentThreadNumber + "#" + referenceId;
			}

			if (
				!globalData.threadId
				|| !globalData.postIds.has(referenceId)) {
				return '/' + referenceId;
			}
			return '/' + globalData.threadId + "#" + referenceId;
		}

		function calculateTimeAgo(postTime) {
			const now = Date.now();
			const past = postTime;
			const seconds = Math.round((now - past) / 1000);
			const minutes = Math.round(seconds / 60);
			const hours = Math.round(minutes / 60);
			const days = Math.round(hours / 24);
			if (seconds < 60) {
				return seconds <= 0 ? "just now" : `${seconds} seconds ago`;
			} else if (minutes < 60) {
				return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
			} else if (hours < 24) {
				return `${hours} hour${hours === 1 ? '' : 's'} ago`;
			} else {
				return `${days} day${days === 1 ? '' : 's'} ago`;
			};
		};

		function renderSharedData(container, data) {
			container.find('.body').html(data.body.split(/\r?\n/).map(line => {
				line = line.trim().replace(/&gt;&gt;(\d+)/g, (_, id) => renderReference(id))
				if (line.match(/^&gt;/)) {
					return `<span class="greentext">${line}</span>`;
				}
				return line;
			}).join("\r\n"));
			container.find('.body').html(
				container.find('.body').html().replace(
					/\[spoiler\]([^<]*?)\[\/spoiler\]/,
					'<span class="spoiler">$1</span>'
				).replace(
					/(https?:\/\/[^\s<,]+)/g,
					'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
				)
			);

			const epochMilliseconds = data.postTime;
			const postDate = new Date(epochMilliseconds);
			const weekday = dayOfWeek[postDate.getDay()];
			const [month, day, year, hour, minutes, seconds] = [
				String(postDate.getMonth() + 1).padStart(2, '0'),
				String(postDate.getDate()).padStart(2, '0'),
				postDate.getFullYear(),
				String(postDate.getHours()).padStart(2, '0'),
				String(postDate.getMinutes()).padStart(2, '0'),
				String(postDate.getSeconds()).padStart(2, '0'),
			];

			const timeSincePost = calculateTimeAgo(data.postTime)
			const displayDate = `${year}/${month}/${day} (${weekday}) ${hour}:${minutes}:${seconds}`;

			const styledDate = `<div class="date">${displayDate}		
										<span class="tooltiptext">${timeSincePost}</span>	
								</div>`;

			container.find('.header .title').html(data.title)
			container.find('.header .name').html(data.name ?? "Jyanshi")
			container.find('.header .date').html(styledDate)
			container.find('.header .date')[0].addEventListener('mouseenter', (e) => { container.find('.header .date .tooltiptext').text(calculateTimeAgo(data.postTime)) })
			container.find('.header .link').attr('href', getReferenceHref(data.postNumber, data.parentThreadNumber))
			container.find('.header .link').attr('id', data.postNumber)
			container.find('.header .numbers').text(
				data.parentThreadNumber
					? data.parentThreadNumber + "#" + data.postNumber
					: data.postNumber
			).on('click', (e) => {
				if (!getThreadId()) {
					window.location = getReferenceHref(data.postNumber, data.parentThreadNumber)
					return;
				}
				let textArea = $('.form.floating textarea')
				if ($('.form.floating').hasClass('hidden')) {
					textArea.val('')
				}
				$('.form.floating').removeClass('hidden').css('top', e.pageY).css('left', e.pageX);
				textArea.val(textArea.val() + ">>" + data.postNumber + "\r\n")

				if (globalData.selectedText) {
					let quote = '>' + globalData.selectedText.trim().replace(/\r?\n/g, "\r\n>")
					textArea.val(textArea.val() + quote + "\r\n")
				}

				textArea.prop('selectionStart', textArea.val().length).focus()
			})

			container.find('.header .reply a').attr('href', '/' + data.postNumber)

			container.find('.header .numbers').attr('data-post', data.postNumber)

			container.find('.header .id').text(data.posterId)

			container.find('.menu').on('click', function () {
				$(this).find('.options').toggleClass('hidden')
			})

			if (data.banned) {
				$('<div/>').addClass('banned').text('USER WAS BANNED FOR THIS POST').appendTo(container.find('.body'))
			}

			if (authToken) {
				container.find('.menu .delete')
					.clone()
					.removeClass('delete')
					.addClass('ban')
					.text('U sure?')
					.on('click', () => { })
					.prependTo(container.find('.menu .options'));
				container.find('.menu .delete')
					.clone()
					.removeClass('delete')
					.addClass('ban')
					.text('Ban')
					.on('click', () => fetch(baseUrl + "bulletin/ban/" + data.postNumber, {
						method: 'post',
						headers: {
							"Accept": "application/json",
							"Content-Type": "application/json",
							...authHeaders
						},
					}))
					.appendTo(container.find('.menu .options'));

				container.find('.menu .delete')
					.clone()
					.removeClass('delete')
					.addClass('spoiler')
					.text('Spoiler')
					.on('click', () => fetch(baseUrl + "bulletin/spoiler/" + data.postNumber, {
						method: 'post',
						headers: {
							"Accept": "application/json",
							"Content-Type": "application/json",
							...authHeaders
						},
					}))
					.appendTo(container.find('.menu .options'));
			}

			container.find('.menu .delete').on('click', () => {
				fetch(baseUrl + "bulletin/" + data.postNumber, {
					method: 'delete',
					headers: {
						"Accept": "application/json",
						"Content-Type": "application/json",
						...authHeaders
					},
					body: JSON.stringify({
						deleteId
					})
				})
			})

			if (data.quotes) {
				const quotes = data.quotes.map(renderReference)
				container.find('.quotes').append(quotes)
			}

			if (!data.imageData) {
				return
			}
			container.find('.meta').removeClass('hidden')
			container.find('.meta a').text(data.imageData.fileName)
			container.find('.meta a').attr('href', imageUrl(data._id, data.imageData))
			container.find('.meta a').attr('download', true)
			container.find('.meta a').attr('filename', data.imageData.fileName)
			container.find('.meta .data').text(`(${toReadableFileSize(data.imageData.fileSize)}, ${data.imageData.dimensions[0]}x${data.imageData.dimensions[1]})`)
			const imageWrapper = $('<a>', { href: imageUrl(data._id, data.imageData), onclick: 'return false' })
			const image = $('<img>', { class: 'image thumb', src: imageUrl(data._id, data.imageData, true) });
			if (data.imageData.thumbDimensions?.length && data.imageData.thumbDimensions[0] < 256 && data.imageData.thumbDimensions[1] < 256) {
				image[0].setAttribute('width', data.imageData.thumbDimensions[0]);
				image[0].setAttribute('height', data.imageData.thumbDimensions[1]);
			}
			if (data.imageData.spoiler) {
				image.addClass('spoiler');
			}
			image.addClass('thumb');
			image.on('click', function () {
				const expand = !$(this).data('expanded');
				if (data.imageData.spoiler) {
					image.toggleClass('spoiler', !expand);
				}
				$(this).data('expanded', expand);
				if (expand){
					$(this)[0].removeAttribute('width');
					$(this)[0].removeAttribute('height');
					$(this).removeClass('thumb');
				}
				else{
					if(data.imageData.thumbDimensions[0] < 256 && data.imageData.thumbDimensions[1] < 256) {
						$(this)[0].setAttribute('width', data.imageData.thumbDimensions[0]);
						$(this)[0].setAttribute('height', data.imageData.thumbDimensions[1]);
					}
					$(this).addClass('thumb');
				}
				$(this).attr('src', imageUrl(data._id, data.imageData, !expand));
			});
			image.appendTo(imageWrapper);

			container.find('.meta').after(imageWrapper);
		}

		function updateCount(replies = 0, totalReplies = 0, uniqueReplies = 0,) {
			$('.control.bottom .unique').text(uniqueReplies + " Unique Posters")

			$('.control.bottom .count').text(totalReplies + " Replies")
			const deleted = totalReplies - replies
			if (deleted > 0) {
				$('.control.bottom .deleted').text(deleted + " Deleted")
			} else {
				$('.control.bottom .deleted').text("")
			}

			if (totalReplies >= 300) {
				$('.control.bottom .notification').text("Bump limit reached")
			} else if (totalReplies > 275) {
				$('.control.bottom .notification').text("Thread is nearing bump limit")
			}
		}

		function loadThread(threadId) {
			$('.control #refresh').removeClass('hidden')
			$('.control label[for="refresh"]').removeClass('hidden')
			saveScrollPosOnRefresh()

			return fetch(baseUrl + "bulletin/" + threadId, {
				headers: authHeaders
			})
				.catch(() => showNotFound())
				.then(body => body.json())
				.then(data => {
					globalData.lastPostNumber = data.posts.length && data.posts[data.posts.length - 1].postNumber;

					if (data.thread.title) {
						const decodedTitle = $("<div/>").html(data.thread.title).text();
						document.title = decodedTitle + " - 4han";
					}
					globalData.threadId = data.thread.postNumber;

					if (threadId.toString() !== data.thread.postNumber.toString()) {
						const url = data.thread.postNumber + "#" + threadId
						globalData.threadId = data.thread.postNumber
						history.replaceState(null, "", "/" + url)
					}
					globalData.postIds.add(data.thread.postNumber)
					data.posts.forEach(post => globalData.postIds.add(post.postNumber))

					const op = renderOP(data.thread, data.posts).appendTo($('#main'))
					const posts = data.posts.map((entry) => renderPost(entry))
					op.append(posts)

					if (window.location.hash) {
						window.location.hash = window.location.hash
					}
					restoreScrollPos();

					updateCount(
						data.thread.replies,
						data.thread.totalReplies,
						data.thread.uniqueReplies,
					)
				})
		}

		function loadUpdate(threadId, lastPostId) {
			const lastPostIdAttr = lastPostId ? "?lastPostId=" + lastPostId : ""
			return fetch(baseUrl + "bulletin/" + threadId + lastPostIdAttr, {
				headers: authHeaders
			})
				.then(body => body.json())
				.then(data => {
					let newYous = 0
					let newPostIds = new Set();
					// NB: Pre-emptively note all the new post numbers so backend-provided
					// quotes are considered in-thread.
					data.posts.forEach(post => {
						newPostIds.add(post.postNumber)
						globalData.postIds.add(post.postNumber)
					})
					data.posts.forEach((post) => {
						for (const [_, quotedId] of [...post.body.matchAll(/&gt;&gt;(\d+)/g)]) {
							const parsedId = parseInt(quotedId, 10)
							if (globalData.authoredPostIds.has(parsedId)) {
								newYous += 1
							}
							if (newPostIds.has(parsedId)) {
								// Posts received in this batch will already have quotes set.
								continue
							}
							$(`.post:not(.post-preview) .numbers[data-post="${parsedId}"]`)
								.siblings('.quotes')
								.append(renderReference(post.postNumber))
						}

                        const newPost = renderPost(post);
                        newPostObserver.observe(newPost[0]);
						newPost.appendTo($('.thread:not(.template)'))
					})

					updateCount(
						data.thread.replies,
						data.thread.totalReplies,
						data.thread.uniqueReplies,
					)
					return {
						lastPostNumber: data.posts.length ? data.posts[data.posts.length - 1].postNumber : lastPostId,
						postsLoaded: data.posts.length,
						newYous,
					}
				})
		}

		function loadCatalog() {
			return fetch(baseUrl + "bulletin/catalog", {
				headers: authHeaders
			})
				.then(body => body.json())
				.then(data => {
					$("#catalog").removeClass('hidden');
					for (const thread of data) {
						const item = $(".catalog-item.template")
							.clone()
							.removeClass('template');
						item.find('a')
							.attr('href', `/${thread.postNumber}`)
							.find('img')
							.addClass('image')
							.attr('src', imageUrl(thread._id, thread.imageData, true));

						item.find('.replies').text(`${thread.replies ?? 0} Replies`);
						if (thread.title) {
							item.find('.body .title').html(thread.title + ':');
						}
						item.find('.body .content').html(thread.body);
						item.appendTo($("#catalog"));
					}
				});
		}

		function loadLatest() {
			return fetch(baseUrl + "bulletin/latest", {
				headers: authHeaders
			})
				.then(body => body.json())
				.then(data => {
					const divider = $('<div/>').addClass('divider')
					const threads = data.posts.flatMap((entry) => {
						const op = renderOP(entry);
						return [
							$('<div/>').addClass('divider'),
							op,
						]
					}).slice(1);
					$('#main').append(threads);
				})
		}

		function startRefreshTimer(data, max = 10, current = max) {
			$('.timer').text(current)
			if (current === 0) {
				const oldLastPost = $('.thread .post:not(.post-preview):last-child').first()

				loadUpdate(data.threadId, data.lastPostNumber).then(n => {
					$('#refresh-error').text('')
					data.lastPostNumber = n.lastPostNumber

					if (n.newYous) {
						if (!globalData.originalFavicon) {
							globalData.originalFavicon = $('link[rel="icon"]')
							globalData.originalFavicon.remove()
							$('<link>', {
								rel: 'icon',
								type: 'image/gif',
								href: '/gifs/meido-alert.gif',
							}).appendTo('head')
						}
					}

					if (n.postsLoaded) {
						if (!globalData.unreadPosts) {
							$('<div>', { class: "divider new-posts-line" }).insertAfter(oldLastPost)
						}
						globalData.originalTitle = globalData.originalTitle ?? document.title
						globalData.unreadPosts = (globalData.unreadPosts ?? 0) + n.postsLoaded
						document.title = `(${globalData.unreadPosts}) ${globalData.originalTitle}`

						data.refreshTimer = setTimeout(() => {
							startRefreshTimer(data)
						}, 1000)
					} else {
						data.refreshTimer = setTimeout(() => {
							startRefreshTimer(data, max + 10)
						}, 1000)
					}
				}).catch(e => {
					$('#refresh-error').text(e)
					data.refreshTimer = setTimeout(() => {
						startRefreshTimer(data, 300)
					}, 1000)
				})
				return;
			}

			data.refreshTimer = setTimeout(() => {
				startRefreshTimer(data, max, current - 1)
			}, 1000)
		}

		function randomBannerUrl() {
			return 'https://repo.riichi.moe/boards/banners/' + banners[banners.length * Math.random() | 0]
		}

		$(() => {
			$('form').trigger('reset')
			$('input[type=checkbox]').prop('checked', false);
			$('.form.floating .x').on('click', () => $('.form.floating').addClass('hidden'))

			$('html')
				.on("mousemove", function (e) {
					if (!globalData.isDragging) {
						return
					}
					$('.form.floating').css('top', e.pageY - globalData.topPos)
					$('.form.floating').css('left', e.pageX - globalData.leftPos)
					e.preventDefault()
				})
				.mouseup(function () {
					globalData.isDragging = false
				})
			$(".form.floating .drag")
				.mousedown(function (e) {
					globalData.isDragging = true
					const offset = $(this).offset()
					globalData.leftPos = e.pageX - offset.left
					globalData.topPos = e.pageY - offset.top
					e.preventDefault()
				})

			$('#theme-selector').val(localStorage.getItem('theme'));
			$('#theme-selector').change((ev) => {
				let theme = `${ev.target.value}`;
				$('body').attr('id', theme);
				localStorage.setItem('theme', theme);
			});

			$('.bannerImage')
				.attr('src', randomBannerUrl())
				.on('click', (e) => e.target.setAttribute('src', randomBannerUrl()))

			$('.control .top').on('click', () => window.scrollTo({ top: 0, behavior: "smooth" }))
			$('.control .bottom').on('click', () => window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }))
			$('.control .reply').on('click', (e) => {
				$('.form.top textarea').append(">>" + globalData.threadId + "\r\n").focus()
			})
			$('.control .update').on('click', () => {
				if (globalData.threadId) {
					loadUpdate(globalData.threadId, globalData.lastPostNumber).then(n => globalData.lastPostNumber = n.lastPostNumber)
					return;
				}
				window.location.reload();
			})

			$('form').on('submit', function (e) {
				e.preventDefault()

				if (globalData.submissionInflight) {
					return
				}
				globalData.submissionInflight = true

				const formData = new FormData(e.target)
				formData.append('deleteId', deleteId)
				let url = baseUrl + "bulletin"
				if (globalData.threadId) {
					url += '/' + globalData.threadId
				}
				fetch(url, {
					method: "post",
					headers: authHeaders,
					body: formData
				})
					.then(res => {
						globalData.submissionInflight = false

						if (res.status !== 200) {
							res.text().then(text => $('.error').text(text))
							return
						}
						$(e.target).trigger('reset')
						if (!globalData.threadId) {
							res.text().then(text => window.location = '/' + text)
							return
						}
						window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" })
						$('.error').text("")
						$('.form.floating').addClass('hidden')
						$(e.target).trigger('reset')
						res.text().then(addAuthoredPostId)
						loadUpdate(globalData.threadId, globalData.lastPostNumber).then(n => globalData.lastPostNumber = n.lastPostNumber)
					})
					.catch(err => console.log(err));
			})

			$('form input[type="file"]').on('change', (e) => {
				const files = Array.from(e.target.files)
				if (files.length && files[0].size > maxFileSize) {
					$(e.target).parent().find('.error').text(`This file exceeds ${maxFileSize} bytes`)
					e.target.value = null
				} else {
					$(e.target).parent().find('.error').text('')
				}
			})

			$('#refresh').on('input', (e) => {
				if (!e.target.checked) {
					$('.timer').text("")
					if (globalData.refreshTimer) {
						clearTimeout(globalData.refreshTimer);
					}
					return;
				}
				startRefreshTimer(globalData, 0)
			})

			$(document).on('selectionchange', function (e) {
				let selection = document.getSelection()
				let startBody = $(selection.anchorNode).parents('.body').first()
				let endBody = $(selection.focusNode).parents('.body').first()

				if (selection?.focusNode?.parentElement?.classList?.contains('numbers')) {
					// ignore the click to open the reply form
				} else if (startBody.length && endBody.length && startBody[0] == endBody[0]) {
					globalData.selectedText = selection.toString()
				} else {
					globalData.selectedText = ''
				}
			})

			$(document).on('mouseenter', '.reference', (e) => {
				if (globalData.referencePreview) {
					return
				}

				globalData.referencePreview = true
				const elem = $(e.target)
				const postNumber = parseInt(elem.text().slice(2), 10)
				const targetNumbers = $(`.numbers[data-post="${postNumber}"]`).first()

				if (!targetNumbers.length) {
					fetch(baseUrl + '/bulletin/preview/' + postNumber)
						.then(data => {
							if (data.status === 404) {
								elem.addClass('deleted').removeAttr('href').text('>>' + postNumber)
								return
							}

							if (data.status !== 200) {
								return;
							}

							return data.json()
						})
						.then(post => post && globalData.referencePreview && renderPreview(
							renderPost(post).find('.content'),
							elem
						))
					return;
				}

				const post = targetNumbers.parents('.content').first()
				if (post.length) {
					renderPreview(post.clone(), elem)
					return
				}

				const thread = targetNumbers.parents('.thread').first()
				renderPreview(
					$('<div>', { class: 'content' }).append(
						thread.children('.meta, .header, a, .body').clone()
					),
					elem
				)

			})

			$(document).on('mouseleave', '.reference', (e) => {
				const elem = $(e.currentTarget)
				globalData.referencePreview = false
				elem.parent().find('.post-preview').remove()
			})

			document.addEventListener('keyup', (e) => {
				if (e.key == 'Escape') {
					$('.form.floating').addClass('hidden')
				}
			})

			if (globalData.threadId) {
				$('.header .reply').addClass('hidden');
				loadThread(globalData.threadId)
				return;
			}
			$('.control .reply').addClass('hidden');

			if (window.location.pathname === "/catalog") {
				loadCatalog();
				return;
			}

			if (window.location.pathname === "/latest") {
				loadLatest();
				return;
			}

			loadIndex();
		});
	</script>
	<div class="thread template">
		<div class="meta">
			<span>File:</span>
			<a href=""></a>
			<span class="data"></span>
		</div>
		<span class="header">
			<span class="name"></span>
			<span class="title"></span>
			<div class="date">
				<span class="tooltiptext"></span>
			</div>
			<a class="link">No.</a>

			<span class="numbers"></span>
			<span class="id"></span>
			<span class="reply">
				[<a>Reply</a>]
			</span>
			<span class="menu">&#9654;
				<div class="options hidden">
					<div class="delete">Delete</div>
				</div>
			</span>
			<span class="quotes"></span>
		</span>
		<div class="body"></div>
		<div class="expander hidden">
			<div class="icon plus"></div>
			<span class="replies-count"></span>
			<span class="link">Click here</span>
			<span> to view.</span>
		</div>
		<div class="collapser hidden">
			<div class="icon minus"></div>
			<span class="link">Hide Replies</span>
		</div>
	</div>
	<div class="post template">
		<span class="arrows">&gt;&gt;</span>
		<div class="content">
			<a></a>
			<div class="header">
				<span class="name"></span>
				<span class="title"></span>
				<span class="date"></span>
				<a href="" class="link">No.</a>
				<span class="numbers"></span>
				<span class="id"></span>
				<span class="menu">&#9654;
					<div class="options hidden">
						<div class="delete">Delete</div>
					</div>
				</span>
				<span class="quotes"></span>
			</div>
			<div class="meta hidden">
				<span>File:</span>
				<a href=""></a>
				<span class="data"></span>
			</div>
			<div class="body">
			</div>
		</div>
	</div>
	<div class="catalog-item template">
		<a><img></a>
		<div class="replies"></div>
		<div class="body">
			<span class="title"></span>
			<span class="content"></span>
		</div>
	</div>
	<div class="banner">
		<div class="title"><a href="/">4han</a></div>
		<img class="bannerImage">
		<div>[<a href="https://repo.riichi.moe/index2.html" class="repo">
				<h3>Actual Repo here</h3>
			</a>]</div>
		<div class="announcements">
			<div>Bump Limit set to 300 posts, thread limit at ~40 threads.</div>
		</div>
		<div class="form top">
			<form>
				<div class="row">
					<label for="name">Name:</label>
					<input type="text" name="name" id="name">
				</div>
				<div class="row">
					<label for="title">Title:</label>
					<input type="text" name="title" id="title">
				</div>
				<textarea type="textarea" id="body" name="body"></textarea>
				<div class="row">
					<input type="checkbox" name="spoiler" id="spoiler">
					<label for="spoiler">Spoiler</label>
					<input type="file" id="image" name="image">
					<span class="error"></span>
					<input type="submit" value="Post">
				</div>
			</form>
		</div>
	</div>
	<div class="divider"></div>
	<div class="control top">
		<a href="/" class="threads">Threads</a>
		<span class="bottom button">Bottom</span>
		<span class="reply button">Reply</span>
		<span class="update button">Update</span>
		<span class="spread"></span>
		<span class="catalog button"><a href="/catalog">Catalog</a></span>
	</div>
	<div class="divider"></div>
	<div id="main">
	</div>
	<div id="catalog" class="hidden">

	</div>
	<div class="divider"></div>

	<div class="control bottom">
		<a href="/" class="threads">Threads</a>
		<span class="top button">Top</span>
		<span class="reply button">Reply</span>
		<span class="update button">Update</span>
		<input class="hidden" type="checkbox" name="refresh" id="refresh" checked="false">
		<label class="hidden" for="refresh">Auto</label>
		<span class="timer"></span>
		<span id="refresh-error"></span>
		<span class="notification"></span>
		<span class="unique"></span>
		<span class="count"></span>
		<span class="deleted"></span>
		<span class="theme-selector-box">
			<label for="theme-selector">Theme</label>
			<select id="theme-selector">
				<option value="default-theme" selected="selected">Default</option>
				<option value="dark-theme">Dark</option>
			</select>
		</span>
		<span class="catalog button"><a href="/catalog">Catalog</a></span>
	</div>
	<div class="divider"></div>
	<span class="page-link template">[<a></a>]</span>
	<div class="pages hidden"></div>
	<div class="form-container">
		<div class="form bottom">
			<form>
				<div class="row">
					<label for="name">Name:</label>
					<input type="text" name="name" id="name">
				</div>
				<div class="row">
					<label for="title">Title:</label>
					<input type="text" name="title" id="title">
				</div>
				<textarea type="textarea" id="body" name="body"></textarea>
				<div class="row">
					<input type="checkbox" name="spoiler" id="spoiler">
					<label for="spoiler">Spoiler</label>
					<input type="file" id="image" name="image">
					<span class="error"></span>
					<input type="submit" value="Post">
				</div>
			</form>
		</div>
	</div>
	<div class="form floating hidden">
		<div class="drag">
			<span class="x">✖</span>
		</div>
		<form>
			<div class="row">
				<label for="name">Name:</label>
				<input type="text" name="name" id="name">
			</div>
			<div class="row">
				<label for="title">Title:</label>
				<input type="text" name="title" id="title">
			</div>
			<textarea type="textarea" id="body" name="body"></textarea>
			<div class="row">
				<input type="checkbox" name="spoiler" id="spoiler">
				<label for="spoiler">Spoiler</label>
				<input type="file" id="image" name="image">
				<span class="error"></span>
				<input type="submit" value="Post">
			</div>
		</form>
	</div>

</body>

</html>
